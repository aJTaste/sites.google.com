# チャット機能仕様書

## 概要
AppHub のチャット機能は、Discord のような段階的な構造を目指している。

## 実装フェーズ

### 第1フェーズ（完了）
**基本的な1対1 DM 機能**

#### 実装済み機能
- ユーザー一覧表示
  - オンライン状態表示（緑の丸）
  - 最終ログイン時刻表示
  - オンラインユーザーを上位に表示
- リアルタイムメッセージ送受信
  - Firebase Realtime Database の `onValue` 使用
  - メッセージは新しい順に並び、最下部に自動スクロール
- メッセージ日時表示
  - 今日: "14:30"
  - 昨日: "昨日 14:30"
  - それ以前: "11月1日 14:30"
- 入力UI
  - Enter で送信、Shift+Enter で改行
  - テキストエリア自動リサイズ（最大120px）
  - 送信中は入力欄と送信ボタンを無効化
  - 連続送信防止

#### UI/UX の特徴
- Discordライクなレイアウト
  - 左サイドバー（60px）: アプリ切り替え
  - DM サイドバー（280px）: ユーザー一覧
  - メインエリア: メッセージ表示
- レスポンシブ対応（768px以下でサイドバー非表示）

### 第2フェーズ（計画中）
**便利機能の追加**

#### 未読件数バッジ
- **表示場所**: ユーザー一覧の各ユーザー
- **表示形式**: `(3)` のような数字
- **カウント方法**: 
  - 最後に開いた時刻以降のメッセージ数
  - 自分のメッセージはカウントしない

#### 既読機能
- **仕様**: 
  - メッセージを開いたら既読になる
  - 相手に「既読」マークを表示
- **データ構造案**:
  ```
  /dms/{dmId}/messages/{messageId}
    read: boolean または {userId: timestamp}
  ```

#### メッセージ削除機能
- **権限**: 自分のメッセージのみ削除可能
- **UI**: ホバーでゴミ箱アイコン表示
- **実装**: Firebase の `remove()` を使用

#### タイピング中表示
- **表示**: 「○○が入力中...」
- **実装**: 
  - `/dms/{dmId}/typing/{userId}` に timestamp を保存
  - 3秒以上更新がなければ消える

#### メッセージ編集機能
- **権限**: 自分のメッセージのみ編集可能
- **表示**: 「(編集済み)」マークを表示
- **データ構造**:
  ```
  /dms/{dmId}/messages/{messageId}
    editedAt: timestamp (optional)
  ```

### 第3フェーズ（未定）
**サーバー/チャンネル機能**

#### サーバー機能
- サーバー作成（`verified` 権限以上）
- サーバー削除（サーバー主のみ）
- メンバー招待
- サーバー内権限管理
  - サーバー主
  - モデレーター
  - メンバー

#### チャンネル機能
- テキストチャンネル
- チャンネルの作成・削除（モデレーター以上）
- チャンネルごとのメッセージ管理

## 技術的な設計

### オンライン状態の管理
```javascript
// ログイン時
await update(ref(database, `users/${uid}`), {
  online: true,
  lastOnline: Date.now()
});

// ページを閉じる時
window.addEventListener('beforeunload', async () => {
  await update(ref(database, `users/${uid}`), {
    online: false,
    lastOnline: Date.now()
  });
});
```

### DM ID の生成
```javascript
function getDmId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}
```
- 2人のユーザーIDをアルファベット順にソート
- アンダースコアで結合
- 例: `"abc123_xyz789"`

### メッセージの送信
```javascript
const dmId = getDmId(currentUser.uid, selectedUserId);
const messagesRef = ref(database, `dms/${dmId}/messages`);
const newMessageRef = push(messagesRef);

await set(newMessageRef, {
  senderId: currentUser.uid,
  text: messageText,
  timestamp: Date.now()
});
```

### リアルタイム更新
```javascript
onValue(messagesRef, (snapshot) => {
  // スナップショットからメッセージを取得
  // タイムスタンプでソート
  // 画面に表示
});
```

## パフォーマンス最適化

### 現在の対策
1. **メッセージの即時クリア**: 送信と同時にテキストボックスをクリア
2. **送信中フラグ**: 連続送信を防止
3. **リスナーの適切な削除**: `off()` でリスナーを削除

### 将来的な最適化案
1. **ペジネーション**: 古いメッセージは遅延読み込み
2. **メッセージのキャッシュ**: 一度読み込んだメッセージをメモリに保持
3. **画像の遅延読み込み**: アイコンやファイルを遅延読み込み

## セキュリティ

### 現在の対策
1. **認証必須**: ログインしていないとアクセス不可
2. **HTMLエスケープ**: XSS 対策
3. **Firebase ルール**: 認証済みユーザーのみ読み書き可能

### 将来的な強化案
1. **DM の権限チェック**: 参加者以外は読み書き不可
2. **スパム防止**: 短時間に大量送信を制限
3. **不適切コンテンツのフィルタリング**: NGワードチェック

## UI/UX の改善案

### すぐに実装可能
- [ ] メッセージの日付セパレーター（「今日」「昨日」など）
- [ ] スクロール位置の記憶
- [ ] メッセージ送信時のアニメーション

### 中長期的な改善
- [ ] リアクション機能（絵文字）
- [ ] メンション機能（@ユーザー名）
- [ ] ファイル添付
- [ ] 音声・ビデオ通話（将来的に）

## 既知の問題と制約

### 制約事項
- デベロッパーツール使用不可（デバッグが困難）
- localStorage 使用不可（Claude.ai artifacts の制約）
- アイコン画像はbase64保存（ファイルストレージ不使用）

### 解決済みの問題
1. ユーザー一覧が表示されない → Firebase ルール設定の変更
2. Enter キー連打で大量送信 → `isSending` フラグで解決